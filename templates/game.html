{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
<div class="container mt-4">
    <h2 class="text-center mb-4">Tic-Tac-Toe Game - Room {{ room }}</h2>
    <div class="alert alert-primary text-center">
        You're: <strong>{{ player_marker }}</strong>
    </div>
    <div id="notification" class="alert alert-info" role="alert"></div>
    <div id="game-board" class="d-flex flex-wrap justify-content-center" style="max-width: 300px;">
        {% for i in range(9) %}
        <div class="cell border border-secondary text-center" style="width: 33.33%; height: 100px; line-height: 100px; cursor: pointer;" data-cell-index="{{ i }}"></div>
        {% endfor %}
    </div>
    <button id="game-reset" class="btn btn-primary mt-3">Reset Game</button>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const socket = io.connect('http://' + document.domain + ':' + location.port);
    const room = "{{ room }}";
    const player_marker = "{{ player_marker }}";
    let gameActive = true;
    let currentPlayer = null;

    const cells = document.querySelectorAll('.cell');
    const notification = document.getElementById('notification');
    const resetButton = document.getElementById('game-reset');

    socket.on('connect', () => {
        socket.emit('join', { room });
    });

    socket.on('start_game', (data) => {
        currentPlayer = data.currentPlayer;
        gameActive = true; // Reactivate the game
    });

    socket.on('move', (data) => {
        cells[data.index].textContent = data.player_marker;
        currentPlayer = data.next_player; // Switch the turn to the next player
        checkGameStatus();
    });

    socket.on('notification', (data) => {
        showNotification(data.msg, data.type === 'error' ? 'alert-danger' : 'alert-success');
    });

    socket.on('reset', () => {
        resetGameState();  // Call the reset game state function when reset is received
    });

    cells.forEach(cell => {
        cell.addEventListener('click', () => {
            if (!gameActive) {
                showNotification("Game is not active. Please reset.", 'alert-warning');
                return;
            }
            if (!cell.textContent.trim()) {
                const index = cell.getAttribute('data-cell-index');
                makeMove(index);
            }
        });
    });

    resetButton.addEventListener('click', () => {
        socket.emit('reset', { room });
    });

    function makeMove(index) {
        if (!gameActive) {
            showNotification("Game is over. Reset to play again.", 'alert-warning');
            return;
        }
        if (player_marker !== currentPlayer) {
            showNotification("It's not your turn!", 'alert-warning');
            return;
        }
        socket.emit('move', { index, player_marker, room });
    }

    function checkGameStatus() {
        const winCombinations = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8],
            [0, 3, 6], [1, 4, 7], [2, 5, 8],
            [0, 4, 8], [2, 4, 6]
        ];
        
        let winner = null;
        winCombinations.forEach(combination => {
            const [a, b, c] = combination;
            if (cells[a].textContent && cells[a].textContent === cells[b].textContent && cells[a].textContent === cells[c].textContent) {
                winner = cells[a].textContent;
            }
        });

        if (winner) {
            gameActive = false;
            showNotification(winner + " wins!", 'alert-success');
        } else if (Array.from(cells).every(cell => cell.textContent.trim() !== '')) {
            gameActive = false;
            showNotification("It's a draw!", 'alert-success');
        }
    }

    function resetGameState() {
        cells.forEach(cell => {
            cell.textContent = '';
        });
        currentPlayer = 'X'; // X starts after a reset
        gameActive = true;  // Reactivate the game
        showNotification("Game has been reset. Start playing!", 'alert-info');
    }

    function showNotification(message, type = 'alert-info') {
        notification.textContent = message;
        notification.className = 'alert ' + type;
    }
});
</script>
{% endblock %}
